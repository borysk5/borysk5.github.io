<!DOCTYPE HTML>
<html>

<head>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
        table, th, td {
  border:1px solid black;
}
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <div id="canvases"></div>
    <canvas id="myCanvas" hidden></canvas>
    <br>
    <a style="overflow:hidden;font-size:30px"><b>First step:</b> Upload one file to overlay on top of the other</a>
    <form>
        <input accept="image/*" type='file' id="pattern"></input>
    </form>
    <button onclick="magnify(1)">üîç-</button><button onclick="magnify(0)">üîé+</button><br>
    <img id="pat" style="background-image: url('https://thumbs.dreamstime.com/b/fake-transparent-transparency-background-pattern-list-page-61007315.jpg');border: 1px solid black" src="https://upload.wikimedia.org/wikipedia/commons/3/38/Solid_white_bordered.png" alt="your image" />     
    <div style="display:block;position: absolute;border: 1px solid #999999;height:100px;top:80;left:0" id="selectorid"></div><br>
    (click on the image to select part of it)<br>
    <button onclick="shrink()">Shrink to rectangle</button><br>
    <button onclick="remov()">Remove the rectangle</button><br>
    <button onclick="fill()">Fill with color</button><button id="check" onclick="check()">üé®</button><br><a id="a1"/><a id="a2"/><a id="a3"/><a id="a4"/>
    <a style="font-size:30px"><b>Second step:</b> Upload multiple files to add the pattern on top of them (all must have equal size to pattern file)</a>
    <form>
        <input accept="image/*" type='file' id="imgInp" multiple>Upload multiple files</input>
    </form>
    <a style="font-size:30px"><b>Third step:</b> Click this button to process images:</a> <button onclick="doThis()">Process images</button><br>

    <a id="zip" hidden href="" download="images.zip">
      <button>Download all images</button> 
    </a>

    <table id="tabBar"></table>

    <script>
	var cr=0;
	var cg=0;
	var cb=0;
	var ca=0;
	var files;
        var images = 0;
        var imageObj = new Image();
        var imageObj2 = new Image();
 	var moving = false;
	var filling = false;
        var select1x, select1y, select2x, select2y = 0;

        function shrink() {
            var rect = $("#pat")[0].getBoundingClientRect();
	    var rect1 = $("#selectorid")[0].getBoundingClientRect();
            var ratx1 = (rect1.left - rect.left) / rect.width;
            var raty1 = (rect1.top - rect.top) / rect.height;

            var ratx2 = (rect1.right - rect.left) / rect.width;
            var raty2 = (rect1.bottom - rect.top) / rect.height;

            var firstc = $("#myCanvas")[0];
            imageObj2.src = $("#pat")[0].src;
            firstc.width = imageObj2.width;
            firstc.height = imageObj2.height;
            var firstx = firstc.getContext('2d');
            firstx.drawImage(imageObj2, 0, 0);
            var imageData2 = firstx.getImageData(0, 0, imageObj2.width, imageObj2.height);
            
            var data = imageData2.data;
            for(var i=0;i<imageData2.height;i++)
            {
                for(var j=0;j<imageData2.width;j++){
                    if(!(i>imageData2.height*raty1 && i<imageData2.height*raty2 && j>imageData2.width*ratx1 && j<imageData2.width*ratx2)){
                    var cod = (imageData2.width*i+j)*4;
                    imageData2.data[cod + 0] = 0; 
                    imageData2.data[cod + 1] = 0; 
                    imageData2.data[cod + 2] = 0; 
                    imageData2.data[cod + 3] = 0; 
                    }
                    
                }
            }    
                firstx.putImageData(imageData2, 0, 0);
                $("#pat")[0].src = firstc.toDataURL();

        }
        
                function remov() {
            var rect = $("#pat")[0].getBoundingClientRect();
	    var rect1 = $("#selectorid")[0].getBoundingClientRect();
            var ratx1 = (rect1.left - rect.left) / rect.width;
            var raty1 = (rect1.top - rect.top) / rect.height;

            var ratx2 = (rect1.right - rect.left) / rect.width;
            var raty2 = (rect1.bottom - rect.top) / rect.height;

            var firstc = $("#myCanvas")[0];
            imageObj2.src = $("#pat")[0].src;
            firstc.width = imageObj2.width;
            firstc.height = imageObj2.height;
            var firstx = firstc.getContext('2d');
            firstx.drawImage(imageObj2, 0, 0);
            var imageData2 = firstx.getImageData(0, 0, imageObj2.width, imageObj2.height);
            
            var data = imageData2.data;
            for(var i=0;i<imageData2.height;i++)
            {
                for(var j=0;j<imageData2.width;j++){
                    if((i>imageData2.height*raty1 && i<imageData2.height*raty2 && j>imageData2.width*ratx1 && j<imageData2.width*ratx2)){
                    var cod = (imageData2.width*i+j)*4;
                    imageData2.data[cod + 0] = 0; 
                    imageData2.data[cod + 1] = 0; 
                    imageData2.data[cod + 2] = 0; 
                    imageData2.data[cod + 3] = 0; 
                    }
                    
                }
            }    
                firstx.putImageData(imageData2, 0, 0);
                $("#pat")[0].src = firstc.toDataURL();

        }


function fill() {
            var rect = $("#pat")[0].getBoundingClientRect();
	    var rect1 = $("#selectorid")[0].getBoundingClientRect();
            var ratx1 = (rect1.left - rect.left) / rect.width;
            var raty1 = (rect1.top - rect.top) / rect.height;

            var ratx2 = (rect1.right - rect.left) / rect.width;
            var raty2 = (rect1.bottom - rect.top) / rect.height;

            var firstc = $("#myCanvas")[0];
            imageObj2.src = $("#pat")[0].src;
            firstc.width = imageObj2.width;
            firstc.height = imageObj2.height;
            var firstx = firstc.getContext('2d');
            firstx.drawImage(imageObj2, 0, 0);
            var imageData2 = firstx.getImageData(0, 0, imageObj2.width, imageObj2.height);
            
            var data = imageData2.data;
            for(var i=0;i<imageData2.height;i++)
            {
                for(var j=0;j<imageData2.width;j++){
                    if((i>imageData2.height*raty1 && i<imageData2.height*raty2 && j>imageData2.width*ratx1 && j<imageData2.width*ratx2)){
                    var cod = (imageData2.width*i+j)*4;
                    imageData2.data[cod + 0] = cr; 
                    imageData2.data[cod + 1] = cg; 
                    imageData2.data[cod + 2] = cb; 
                    imageData2.data[cod + 3] = ca; 
                    }
                    
                }
            }    
                firstx.putImageData(imageData2, 0, 0);
                $("#pat")[0].src = firstc.toDataURL();

        }

        document.onmousemove = function mouseEvent(e) {
            if (!filling && moving) {
		var rect = $("#pat")[0].getBoundingClientRect();
                var width = Math.abs(e.clientX - select1x - rect.left);
                var height = Math.abs(e.clientY - select1y - rect.top);
		
                var selector = $("#selectorid")[0];
                var t = height + "px";
                selector.style.height = t;
                t = width + "px";
                selector.style.width = t;

                var n = String(Math.min(e.clientX- document.body.getBoundingClientRect().left,Math.floor(select1x+rect.left - document.body.getBoundingClientRect().left))) + "px";
                selector.style.left = n;
                var n1 = String(Math.min(e.clientY- document.body.getBoundingClientRect().top,Math.floor(select1y+rect.top - document.body.getBoundingClientRect().top))) + "px";
                selector.style.top = n1;


            }

        }
	
function componentToHex(c) {
  var hex = c.toString(16);
  return hex.length == 1 ? "0" + hex : hex;
}

        document.onmousedown = function mousedownEvent(e) {
            var rect = $("#pat")[0].getBoundingClientRect();
		if (e.target.id=="pat"){
	    if(filling){
	    var rect1 = $("#selectorid")[0].getBoundingClientRect();
            var ratx1 = (rect1.left - rect.left) / rect.width;
            var raty1 = (rect1.top - rect.top) / rect.height;
 		var firstc = $("#myCanvas")[0];
            imageObj2.src = $("#pat")[0].src;
            firstc.width = imageObj2.width;
            firstc.height = imageObj2.height;
            var firstx = firstc.getContext('2d');
            firstx.drawImage(imageObj2, 0, 0);
            var imageData2 = firstx.getImageData(0, 0, imageObj2.width, imageObj2.height);
            	
		
		var j = (imageData2.width*Math.floor(imageData2.height*raty1)+Math.floor(ratx1*imageData2.width))*4;

		cr = imageData2.data[j+0];
		cg = imageData2.data[j+1];
		cb = imageData2.data[j+2];
		ca = imageData2.data[j+3];
		$("#check")[0].style.background = "#" + componentToHex(cr) + componentToHex(cg) + componentToHex(cb);

	    }
            else {
                moving = true;
                var rect = $("#pat")[0].getBoundingClientRect();

                select1y = e.clientY-rect.top;
                select1x = e.clientX-rect.left;
                //var selector = $(".selector")[0];
                var selector = $("#selectorid")[0];

                selector.style.width = "0px";
                selector.style.height = "0px";

                var n = String(rect.left) + 'px';
                selector.style.left = n;
                n = String(rect.top) + 'px';
                selector.getBoundingClientRect().top = n;

                selector.display = "block";
            }
		}
        }

       document.onmouseup = function mouseupEvent(e) {
            var rect = $("#pat")[0].getBoundingClientRect();
		if(filling)
		{filling = false;}
            else if (e.clientX < rect.right && e.clientY < rect.bottom) {

                moving = false;

            }

        }

        function doThis() {
            var firstc = $("#myCanvas")[0];
            imageObj2.src = $("#pat")[0].src;
            firstc.width = imageObj2.width;
            firstc.height = imageObj2.height;
            var firstx = firstc.getContext('2d');
            firstx.drawImage(imageObj2, 0, 0);
            var imageData2 = firstx.getImageData(0, 0, imageObj2.width, imageObj2.height);
            var photo = $("#tabBar")[0];
            for (var i = 0; i < images; i++) {
                imageObj.src = $("#bruh"+i)[0].src;
		if(imageObj.width!=imageObj2.width || imageObj.height!=imageObj2.height){
		alert("Error: One of provided images has different dimensions than pattern image");
		return;
		};
                var canwes = $("#canvases")[0];
                var canvas = canwes.children[i];
                canvas.width = imageObj.width;
                canvas.height = imageObj.height;
                var context = canvas.getContext('2d');
                context.drawImage(imageObj, 0, 0);
                var imageData = context.getImageData(0, 0, imageObj.width, imageObj.height);
                var data = imageData.data;
                for (var j = 0, n = imageData.data.length; j < n; j += 4) {
                    if (imageData2.data[j + 3] > 0) {
			var aB = imageData.data[j + 3];
			imageData.data[j + 3] = imageData2.data[j + 3] + (aB * (255 - imageData2.data[j + 3]) / 255);
			for(var e=0;e<3;e++){
			imageData.data[j + e] = (imageData2.data[j + e] * imageData2.data[j + 3] + imageData.data[j + e] * aB * (255 - imageData2.data[j + 3]) / 255)/imageData.data[j + 3];
			}
                    }
                }
                //imageData.data = data;
                context.putImageData(imageData, 0, 0);
                $("#bruh"+i)[0].src = canvas.toDataURL();
            }
            $("#zip")[0].hidden = false;
            var zip = new JSZip();
            for (var w = 0; w < images; w++) {
                var t = getCanvasBlob(document.getElementById('canvases').children[w]);
                zip.file(String(files[w].name), t);
            }


            zip.generateAsync({
                type: "base64"
            }).then(function(content) {
                $("#zip")[0].href = "data:application/zip;base64," + content;

            });

        }
	
	


        function getCanvasBlob(canvas) {
            return new Promise(function(resolve, reject) {
                canvas.toBlob(function(blob) {
                    resolve(blob) 
                })
            })
        }


        imgInp.onchange = evt => {
            if(images>0){
                for(var f=0;f<images;f++){
                    document.getElementById('canvases').removeChild( document.getElementById('canvases').children[0]);
                } 
                for(var f=0;f<Math.floor(images / 5)+1;f++){
                    document.getElementById('tabBar').removeChild( document.getElementById('tabBar').children[0]);
                }
                
            }
	    files = imgInp.files;
            images = imgInp.files.length;
            var s = Math.floor(images / 5)+1;
            for (var i = 0; i < s; i++) {

                var tr = document.createElement("tr");
                for (var j = 0; j < 5 && i*5 + j < images; j++) {
                    var z = URL.createObjectURL(imgInp.files[i*5 + j]);
                    var td = document.createElement("td");
                    td.innerHTML="<img id=\"bruh"+(i*5 + j)+"\" width=\""+screen.width/6+"\" src=\""+z+"\"></img>";
                    tr.appendChild(td);
                    
                    var c = document.createElement('canvas');
                    c.id = "canvas" + i*5 + j;
                    c.hidden = true;
                    $("#canvases")[0].appendChild(c);

                }
                $("#tabBar")[0].appendChild(tr);

            }


        }
	function check(){
		filling = true;
		$("#check")[0].style.background = "grey";
	} 
        function magnify(i){
            if(i==0){
		var rect = $("#pat")[0].getBoundingClientRect();
            $("#pat")[0].width = $("#pat")[0].width*1.1;
	    $("#selectorid")[0].style.width = parseInt($("#selectorid")[0].style.width,10)*1.1+"px";
	    $("#selectorid")[0].style.height = parseInt($("#selectorid")[0].style.height,10)*1.1+"px";
	    $("#selectorid")[0].style.left = parseInt($("#selectorid")[0].style.left,10)*1.1+"px";
	    $("#selectorid")[0].style.top = ((parseInt($("#selectorid")[0].style.top,10)-98)*1.1+98)+"px";
            } else if(i==1){
                $("#pat")[0].width = $("#pat")[0].width*0.9;
	    $("#selectorid")[0].style.width = parseInt($("#selectorid")[0].style.width,10)*0.9+"px";
	    $("#selectorid")[0].style.height = parseInt($("#selectorid")[0].style.height,10)*0.9+"px";
	    $("#selectorid")[0].style.left = parseInt($("#selectorid")[0].style.left,10)*0.9+"px";
	    $("#selectorid")[0].style.top = ((parseInt($("#selectorid")[0].style.top,10)-98)*0.9+98)+"px";
            }
            
        }
        pattern.onchange = evt => {
	    var width = $("#pat")[0].width;
            var x = URL.createObjectURL(pattern.files[0]);
	    $("#pat")[0].width = width;
            $("#pat")[0].src = x;

        }
    </script>
</body>

</html>
